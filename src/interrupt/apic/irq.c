#include "irq.h"
#include "interrupt/apic/apic.h"
#include "interrupt/apic/ioapic.h"
#include "interrupt/idt.h"
#include "io/io.h"

__attribute__((no_caller_saved_registers))
void apic_interrupt_handler(struct interrupt_frame* frame, uint8_t vector) {
    (void)frame;

    if (vector < INTERRUPT_BASE) {
        kprintln("ERROR invalid io interrupt vector (%d < %d)", vector, INTERRUPT_BASE);
        apic_eoi();
        return;
    }

    exec_io_handler(vector - INTERRUPT_BASE);
    apic_eoi();
}

#define DEF_INTERRUPT_HANDLER(vector) __attribute__((interrupt)) \
void apic_interrupt_handler_wrapper##vector (struct interrupt_frame* frame) { \
    apic_interrupt_handler(frame, vector); \
}

#define INIT_GATE_IRQ(vector) init_gate(vector, (uint64_t) apic_interrupt_handler_wrapper##vector, CODE_SEG, GATE_PRESENT | INTERRUPT_GATE, IST_NONE);

DEF_INTERRUPT_HANDLER(32)
DEF_INTERRUPT_HANDLER(33)
DEF_INTERRUPT_HANDLER(34)
DEF_INTERRUPT_HANDLER(35)
DEF_INTERRUPT_HANDLER(36)
DEF_INTERRUPT_HANDLER(37)
DEF_INTERRUPT_HANDLER(38)
DEF_INTERRUPT_HANDLER(39)
DEF_INTERRUPT_HANDLER(40)
DEF_INTERRUPT_HANDLER(41)
DEF_INTERRUPT_HANDLER(42)
DEF_INTERRUPT_HANDLER(43)
DEF_INTERRUPT_HANDLER(44)
DEF_INTERRUPT_HANDLER(45)
DEF_INTERRUPT_HANDLER(46)
DEF_INTERRUPT_HANDLER(47)
DEF_INTERRUPT_HANDLER(48)
DEF_INTERRUPT_HANDLER(49)
DEF_INTERRUPT_HANDLER(50)
DEF_INTERRUPT_HANDLER(51)
DEF_INTERRUPT_HANDLER(52)
DEF_INTERRUPT_HANDLER(53)
DEF_INTERRUPT_HANDLER(54)
DEF_INTERRUPT_HANDLER(55)
DEF_INTERRUPT_HANDLER(56)
DEF_INTERRUPT_HANDLER(57)
DEF_INTERRUPT_HANDLER(58)
DEF_INTERRUPT_HANDLER(59)
DEF_INTERRUPT_HANDLER(60)
DEF_INTERRUPT_HANDLER(61)
DEF_INTERRUPT_HANDLER(62)
DEF_INTERRUPT_HANDLER(63)
DEF_INTERRUPT_HANDLER(64)
DEF_INTERRUPT_HANDLER(65)
DEF_INTERRUPT_HANDLER(66)
DEF_INTERRUPT_HANDLER(67)
DEF_INTERRUPT_HANDLER(68)
DEF_INTERRUPT_HANDLER(69)
DEF_INTERRUPT_HANDLER(70)
DEF_INTERRUPT_HANDLER(71)
DEF_INTERRUPT_HANDLER(72)
DEF_INTERRUPT_HANDLER(73)
DEF_INTERRUPT_HANDLER(74)
DEF_INTERRUPT_HANDLER(75)
DEF_INTERRUPT_HANDLER(76)
DEF_INTERRUPT_HANDLER(77)
DEF_INTERRUPT_HANDLER(78)
DEF_INTERRUPT_HANDLER(79)
DEF_INTERRUPT_HANDLER(80)
DEF_INTERRUPT_HANDLER(81)
DEF_INTERRUPT_HANDLER(82)
DEF_INTERRUPT_HANDLER(83)
DEF_INTERRUPT_HANDLER(84)
DEF_INTERRUPT_HANDLER(85)
DEF_INTERRUPT_HANDLER(86)
DEF_INTERRUPT_HANDLER(87)
DEF_INTERRUPT_HANDLER(88)
DEF_INTERRUPT_HANDLER(89)
DEF_INTERRUPT_HANDLER(90)
DEF_INTERRUPT_HANDLER(91)
DEF_INTERRUPT_HANDLER(92)
DEF_INTERRUPT_HANDLER(93)
DEF_INTERRUPT_HANDLER(94)
DEF_INTERRUPT_HANDLER(95)
DEF_INTERRUPT_HANDLER(96)
DEF_INTERRUPT_HANDLER(97)
DEF_INTERRUPT_HANDLER(98)
DEF_INTERRUPT_HANDLER(99)
DEF_INTERRUPT_HANDLER(100)
DEF_INTERRUPT_HANDLER(101)
DEF_INTERRUPT_HANDLER(102)
DEF_INTERRUPT_HANDLER(103)
DEF_INTERRUPT_HANDLER(104)
DEF_INTERRUPT_HANDLER(105)
DEF_INTERRUPT_HANDLER(106)
DEF_INTERRUPT_HANDLER(107)
DEF_INTERRUPT_HANDLER(108)
DEF_INTERRUPT_HANDLER(109)
DEF_INTERRUPT_HANDLER(110)
DEF_INTERRUPT_HANDLER(111)
DEF_INTERRUPT_HANDLER(112)
DEF_INTERRUPT_HANDLER(113)
DEF_INTERRUPT_HANDLER(114)
DEF_INTERRUPT_HANDLER(115)
DEF_INTERRUPT_HANDLER(116)
DEF_INTERRUPT_HANDLER(117)
DEF_INTERRUPT_HANDLER(118)
DEF_INTERRUPT_HANDLER(119)
DEF_INTERRUPT_HANDLER(120)
DEF_INTERRUPT_HANDLER(121)
DEF_INTERRUPT_HANDLER(122)
DEF_INTERRUPT_HANDLER(123)
DEF_INTERRUPT_HANDLER(124)
DEF_INTERRUPT_HANDLER(125)
DEF_INTERRUPT_HANDLER(126)
DEF_INTERRUPT_HANDLER(127)
DEF_INTERRUPT_HANDLER(128)
DEF_INTERRUPT_HANDLER(129)
DEF_INTERRUPT_HANDLER(130)
DEF_INTERRUPT_HANDLER(131)
DEF_INTERRUPT_HANDLER(132)
DEF_INTERRUPT_HANDLER(133)
DEF_INTERRUPT_HANDLER(134)
DEF_INTERRUPT_HANDLER(135)
DEF_INTERRUPT_HANDLER(136)
DEF_INTERRUPT_HANDLER(137)
DEF_INTERRUPT_HANDLER(138)
DEF_INTERRUPT_HANDLER(139)
DEF_INTERRUPT_HANDLER(140)
DEF_INTERRUPT_HANDLER(141)
DEF_INTERRUPT_HANDLER(142)
DEF_INTERRUPT_HANDLER(143)
DEF_INTERRUPT_HANDLER(144)
DEF_INTERRUPT_HANDLER(145)
DEF_INTERRUPT_HANDLER(146)
DEF_INTERRUPT_HANDLER(147)
DEF_INTERRUPT_HANDLER(148)
DEF_INTERRUPT_HANDLER(149)
DEF_INTERRUPT_HANDLER(150)
DEF_INTERRUPT_HANDLER(151)
DEF_INTERRUPT_HANDLER(152)
DEF_INTERRUPT_HANDLER(153)
DEF_INTERRUPT_HANDLER(154)
DEF_INTERRUPT_HANDLER(155)
DEF_INTERRUPT_HANDLER(156)
DEF_INTERRUPT_HANDLER(157)
DEF_INTERRUPT_HANDLER(158)
DEF_INTERRUPT_HANDLER(159)
DEF_INTERRUPT_HANDLER(160)
DEF_INTERRUPT_HANDLER(161)
DEF_INTERRUPT_HANDLER(162)
DEF_INTERRUPT_HANDLER(163)
DEF_INTERRUPT_HANDLER(164)
DEF_INTERRUPT_HANDLER(165)
DEF_INTERRUPT_HANDLER(166)
DEF_INTERRUPT_HANDLER(167)
DEF_INTERRUPT_HANDLER(168)
DEF_INTERRUPT_HANDLER(169)
DEF_INTERRUPT_HANDLER(170)
DEF_INTERRUPT_HANDLER(171)
DEF_INTERRUPT_HANDLER(172)
DEF_INTERRUPT_HANDLER(173)
DEF_INTERRUPT_HANDLER(174)
DEF_INTERRUPT_HANDLER(175)
DEF_INTERRUPT_HANDLER(176)
DEF_INTERRUPT_HANDLER(177)
DEF_INTERRUPT_HANDLER(178)
DEF_INTERRUPT_HANDLER(179)
DEF_INTERRUPT_HANDLER(180)
DEF_INTERRUPT_HANDLER(181)
DEF_INTERRUPT_HANDLER(182)
DEF_INTERRUPT_HANDLER(183)
DEF_INTERRUPT_HANDLER(184)
DEF_INTERRUPT_HANDLER(185)
DEF_INTERRUPT_HANDLER(186)
DEF_INTERRUPT_HANDLER(187)
DEF_INTERRUPT_HANDLER(188)
DEF_INTERRUPT_HANDLER(189)
DEF_INTERRUPT_HANDLER(190)
DEF_INTERRUPT_HANDLER(191)
DEF_INTERRUPT_HANDLER(192)
DEF_INTERRUPT_HANDLER(193)
DEF_INTERRUPT_HANDLER(194)
DEF_INTERRUPT_HANDLER(195)
DEF_INTERRUPT_HANDLER(196)
DEF_INTERRUPT_HANDLER(197)
DEF_INTERRUPT_HANDLER(198)
DEF_INTERRUPT_HANDLER(199)
DEF_INTERRUPT_HANDLER(200)
DEF_INTERRUPT_HANDLER(201)
DEF_INTERRUPT_HANDLER(202)
DEF_INTERRUPT_HANDLER(203)
DEF_INTERRUPT_HANDLER(204)
DEF_INTERRUPT_HANDLER(205)
DEF_INTERRUPT_HANDLER(206)
DEF_INTERRUPT_HANDLER(207)
DEF_INTERRUPT_HANDLER(208)
DEF_INTERRUPT_HANDLER(209)
DEF_INTERRUPT_HANDLER(210)
DEF_INTERRUPT_HANDLER(211)
DEF_INTERRUPT_HANDLER(212)
DEF_INTERRUPT_HANDLER(213)
DEF_INTERRUPT_HANDLER(214)
DEF_INTERRUPT_HANDLER(215)
DEF_INTERRUPT_HANDLER(216)
DEF_INTERRUPT_HANDLER(217)
DEF_INTERRUPT_HANDLER(218)
DEF_INTERRUPT_HANDLER(219)
DEF_INTERRUPT_HANDLER(220)
DEF_INTERRUPT_HANDLER(221)
DEF_INTERRUPT_HANDLER(222)
DEF_INTERRUPT_HANDLER(223)
DEF_INTERRUPT_HANDLER(224)
DEF_INTERRUPT_HANDLER(225)
DEF_INTERRUPT_HANDLER(226)
DEF_INTERRUPT_HANDLER(227)
DEF_INTERRUPT_HANDLER(228)
DEF_INTERRUPT_HANDLER(229)
DEF_INTERRUPT_HANDLER(230)
DEF_INTERRUPT_HANDLER(231)
DEF_INTERRUPT_HANDLER(232)
DEF_INTERRUPT_HANDLER(233)
DEF_INTERRUPT_HANDLER(234)
DEF_INTERRUPT_HANDLER(235)
DEF_INTERRUPT_HANDLER(236)
DEF_INTERRUPT_HANDLER(237)
DEF_INTERRUPT_HANDLER(238)
DEF_INTERRUPT_HANDLER(239)
DEF_INTERRUPT_HANDLER(240)
DEF_INTERRUPT_HANDLER(241)
DEF_INTERRUPT_HANDLER(242)
DEF_INTERRUPT_HANDLER(243)
DEF_INTERRUPT_HANDLER(244)
DEF_INTERRUPT_HANDLER(245)
DEF_INTERRUPT_HANDLER(246)
DEF_INTERRUPT_HANDLER(247)
DEF_INTERRUPT_HANDLER(248)
DEF_INTERRUPT_HANDLER(249)
DEF_INTERRUPT_HANDLER(250)
DEF_INTERRUPT_HANDLER(251)
DEF_INTERRUPT_HANDLER(252)
DEF_INTERRUPT_HANDLER(253)
DEF_INTERRUPT_HANDLER(254)
DEF_INTERRUPT_HANDLER(255)
#undef DEF_INTERRUPT_HANDLER

__attribute__((interrupt))
void apic_spurious_interrupt_handler (struct interrupt_frame* frame) {
    (void)frame;
    // do nothing
}

__attribute__((interrupt))
void apic_err_handler (struct interrupt_frame* frame) {
    (void)frame;
    // do nothing
}

void apic_init_irq_handlers(void) {
    init_gate(254, (uint64_t) apic_err_handler, CODE_SEG, GATE_PRESENT | INTERRUPT_GATE, IST_NONE);
    init_gate(255, (uint64_t) apic_spurious_interrupt_handler, CODE_SEG, GATE_PRESENT | INTERRUPT_GATE, IST_NONE);

    // IRQs --------------------------------------------
    // vec 0 - 19 are exceptions
    // vec 20 - 31 are reserved
    INIT_GATE_IRQ(32)
    INIT_GATE_IRQ(33)
    INIT_GATE_IRQ(34)
    INIT_GATE_IRQ(35)
    INIT_GATE_IRQ(36)
    INIT_GATE_IRQ(37)
    INIT_GATE_IRQ(38)
    INIT_GATE_IRQ(39)
    INIT_GATE_IRQ(40)
    INIT_GATE_IRQ(41)
    INIT_GATE_IRQ(42)
    INIT_GATE_IRQ(43)
    INIT_GATE_IRQ(44)
    INIT_GATE_IRQ(45)
    INIT_GATE_IRQ(46)
    INIT_GATE_IRQ(47)
    INIT_GATE_IRQ(48)
    INIT_GATE_IRQ(49)
    INIT_GATE_IRQ(50)
    INIT_GATE_IRQ(51)
    INIT_GATE_IRQ(52)
    INIT_GATE_IRQ(53)
    INIT_GATE_IRQ(54)
    INIT_GATE_IRQ(55)
    INIT_GATE_IRQ(56)
    INIT_GATE_IRQ(57)
    INIT_GATE_IRQ(58)
    INIT_GATE_IRQ(59)
    INIT_GATE_IRQ(60)
    INIT_GATE_IRQ(61)
    INIT_GATE_IRQ(62)
    INIT_GATE_IRQ(63)
    INIT_GATE_IRQ(64)
    INIT_GATE_IRQ(65)
    INIT_GATE_IRQ(66)
    INIT_GATE_IRQ(67)
    INIT_GATE_IRQ(68)
    INIT_GATE_IRQ(69)
    INIT_GATE_IRQ(70)
    INIT_GATE_IRQ(71)
    INIT_GATE_IRQ(72)
    INIT_GATE_IRQ(73)
    INIT_GATE_IRQ(74)
    INIT_GATE_IRQ(75)
    INIT_GATE_IRQ(76)
    INIT_GATE_IRQ(77)
    INIT_GATE_IRQ(78)
    INIT_GATE_IRQ(79)
    INIT_GATE_IRQ(80)
    INIT_GATE_IRQ(81)
    INIT_GATE_IRQ(82)
    INIT_GATE_IRQ(83)
    INIT_GATE_IRQ(84)
    INIT_GATE_IRQ(85)
    INIT_GATE_IRQ(86)
    INIT_GATE_IRQ(87)
    INIT_GATE_IRQ(88)
    INIT_GATE_IRQ(89)
    INIT_GATE_IRQ(90)
    INIT_GATE_IRQ(91)
    INIT_GATE_IRQ(92)
    INIT_GATE_IRQ(93)
    INIT_GATE_IRQ(94)
    INIT_GATE_IRQ(95)
    INIT_GATE_IRQ(96)
    INIT_GATE_IRQ(97)
    INIT_GATE_IRQ(98)
    INIT_GATE_IRQ(99)
    INIT_GATE_IRQ(100)
    INIT_GATE_IRQ(101)
    INIT_GATE_IRQ(102)
    INIT_GATE_IRQ(103)
    INIT_GATE_IRQ(104)
    INIT_GATE_IRQ(105)
    INIT_GATE_IRQ(106)
    INIT_GATE_IRQ(107)
    INIT_GATE_IRQ(108)
    INIT_GATE_IRQ(109)
    INIT_GATE_IRQ(110)
    INIT_GATE_IRQ(111)
    INIT_GATE_IRQ(112)
    INIT_GATE_IRQ(113)
    INIT_GATE_IRQ(114)
    INIT_GATE_IRQ(115)
    INIT_GATE_IRQ(116)
    INIT_GATE_IRQ(117)
    INIT_GATE_IRQ(118)
    INIT_GATE_IRQ(119)
    INIT_GATE_IRQ(120)
    INIT_GATE_IRQ(121)
    INIT_GATE_IRQ(122)
    INIT_GATE_IRQ(123)
    INIT_GATE_IRQ(124)
    INIT_GATE_IRQ(125)
    INIT_GATE_IRQ(126)
    INIT_GATE_IRQ(127)
    INIT_GATE_IRQ(128)
    INIT_GATE_IRQ(129)
    INIT_GATE_IRQ(130)
    INIT_GATE_IRQ(131)
    INIT_GATE_IRQ(132)
    INIT_GATE_IRQ(133)
    INIT_GATE_IRQ(134)
    INIT_GATE_IRQ(135)
    INIT_GATE_IRQ(136)
    INIT_GATE_IRQ(137)
    INIT_GATE_IRQ(138)
    INIT_GATE_IRQ(139)
    INIT_GATE_IRQ(140)
    INIT_GATE_IRQ(141)
    INIT_GATE_IRQ(142)
    INIT_GATE_IRQ(143)
    INIT_GATE_IRQ(144)
    INIT_GATE_IRQ(145)
    INIT_GATE_IRQ(146)
    INIT_GATE_IRQ(147)
    INIT_GATE_IRQ(148)
    INIT_GATE_IRQ(149)
    INIT_GATE_IRQ(150)
    INIT_GATE_IRQ(151)
    INIT_GATE_IRQ(152)
    INIT_GATE_IRQ(153)
    INIT_GATE_IRQ(154)
    INIT_GATE_IRQ(155)
    INIT_GATE_IRQ(156)
    INIT_GATE_IRQ(157)
    INIT_GATE_IRQ(158)
    INIT_GATE_IRQ(159)
    INIT_GATE_IRQ(160)
    INIT_GATE_IRQ(161)
    INIT_GATE_IRQ(162)
    INIT_GATE_IRQ(163)
    INIT_GATE_IRQ(164)
    INIT_GATE_IRQ(165)
    INIT_GATE_IRQ(166)
    INIT_GATE_IRQ(167)
    INIT_GATE_IRQ(168)
    INIT_GATE_IRQ(169)
    INIT_GATE_IRQ(170)
    INIT_GATE_IRQ(171)
    INIT_GATE_IRQ(172)
    INIT_GATE_IRQ(173)
    INIT_GATE_IRQ(174)
    INIT_GATE_IRQ(175)
    INIT_GATE_IRQ(176)
    INIT_GATE_IRQ(177)
    INIT_GATE_IRQ(178)
    INIT_GATE_IRQ(179)
    INIT_GATE_IRQ(180)
    INIT_GATE_IRQ(181)
    INIT_GATE_IRQ(182)
    INIT_GATE_IRQ(183)
    INIT_GATE_IRQ(184)
    INIT_GATE_IRQ(185)
    INIT_GATE_IRQ(186)
    INIT_GATE_IRQ(187)
    INIT_GATE_IRQ(188)
    INIT_GATE_IRQ(189)
    INIT_GATE_IRQ(190)
    INIT_GATE_IRQ(191)
    INIT_GATE_IRQ(192)
    INIT_GATE_IRQ(193)
    INIT_GATE_IRQ(194)
    INIT_GATE_IRQ(195)
    INIT_GATE_IRQ(196)
    INIT_GATE_IRQ(197)
    INIT_GATE_IRQ(198)
    INIT_GATE_IRQ(199)
    INIT_GATE_IRQ(200)
    INIT_GATE_IRQ(201)
    INIT_GATE_IRQ(202)
    INIT_GATE_IRQ(203)
    INIT_GATE_IRQ(204)
    INIT_GATE_IRQ(205)
    INIT_GATE_IRQ(206)
    INIT_GATE_IRQ(207)
    INIT_GATE_IRQ(208)
    INIT_GATE_IRQ(209)
    INIT_GATE_IRQ(210)
    INIT_GATE_IRQ(211)
    INIT_GATE_IRQ(212)
    INIT_GATE_IRQ(213)
    INIT_GATE_IRQ(214)
    INIT_GATE_IRQ(215)
    INIT_GATE_IRQ(216)
    INIT_GATE_IRQ(217)
    INIT_GATE_IRQ(218)
    INIT_GATE_IRQ(219)
    INIT_GATE_IRQ(220)
    INIT_GATE_IRQ(221)
    INIT_GATE_IRQ(222)
    INIT_GATE_IRQ(223)
    INIT_GATE_IRQ(224)
    INIT_GATE_IRQ(225)
    INIT_GATE_IRQ(226)
    INIT_GATE_IRQ(227)
    INIT_GATE_IRQ(228)
    INIT_GATE_IRQ(229)
    INIT_GATE_IRQ(230)
    INIT_GATE_IRQ(231)
    INIT_GATE_IRQ(232)
    INIT_GATE_IRQ(233)
    INIT_GATE_IRQ(234)
    INIT_GATE_IRQ(235)
    INIT_GATE_IRQ(236)
    INIT_GATE_IRQ(237)
    INIT_GATE_IRQ(238)
    INIT_GATE_IRQ(239)
    INIT_GATE_IRQ(240)
    INIT_GATE_IRQ(241)
    INIT_GATE_IRQ(242)
    INIT_GATE_IRQ(243)
    INIT_GATE_IRQ(244)
    INIT_GATE_IRQ(245)
    INIT_GATE_IRQ(246)
    INIT_GATE_IRQ(247)
    INIT_GATE_IRQ(248)
    INIT_GATE_IRQ(249)
    INIT_GATE_IRQ(250)
    INIT_GATE_IRQ(251)
    INIT_GATE_IRQ(252)
    INIT_GATE_IRQ(253)
#undef INIT_GATE_IRQ
}
